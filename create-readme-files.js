const fs = require('fs').promises;
const glob = require("glob");
const emojis = [
  'ðŸ˜„','ðŸ˜ƒ','ðŸ˜€','ðŸ˜Š','ðŸ˜‰','ðŸ˜','ðŸ˜˜','ðŸ˜š','ðŸ˜—','ðŸ˜™','ðŸ˜œ','ðŸ˜','ðŸ˜›','ðŸ˜³','ðŸ˜','ðŸ˜Œ','ðŸ˜‚','ðŸ˜°','ðŸ˜…','ðŸ˜¨','ðŸ˜±','ðŸ˜Ž','ðŸ˜´','ðŸ˜µ','ðŸ˜²','ðŸ˜Ÿ','ðŸ˜¦','ðŸ˜§','ðŸ˜ˆ','ðŸ‘¿','ðŸ˜®','ðŸ˜¬','ðŸ˜¯','ðŸ˜¶','ðŸ˜‡','ðŸ˜','ðŸ˜‘','ðŸ‘²','ðŸ‘³','ðŸ‘®','ðŸ‘·','ðŸ’‚','ðŸ‘¶','ðŸ‘¦','ðŸ‘§','ðŸ‘¨','ðŸ‘©','ðŸ‘´','ðŸ‘µ','ðŸ‘±','ðŸ‘¼','ðŸ‘¸','ðŸ˜º','ðŸ˜¸','ðŸ˜»','ðŸ˜½','ðŸ˜¼','ðŸ™€','ðŸ˜¿','ðŸ˜¹','ðŸ˜¾','ðŸ‘¹','ðŸ‘º','ðŸ™ˆ','ðŸ™‰','ðŸ™Š','ðŸ’€','ðŸ‘½','ðŸ’©','ðŸ”¥','âœ¨','ðŸŒŸ','ðŸ’«','ðŸ’¥','ðŸ’¢','ðŸ’¦','ðŸ’§','ðŸ’¤','ðŸ’¨','ðŸ‘‚','ðŸ‘€','ðŸ‘ƒ','ðŸ‘…','ðŸ‘„','ðŸ‘','ðŸ‘‹','ðŸ‘','ðŸ’ª','ðŸš¶','ðŸƒ','ðŸ’ƒ','ðŸ‘«','ðŸ‘ª','ðŸ‘¬','ðŸ‘­','ðŸ’','ðŸ’‘','ðŸ‘¯','ðŸ™†','ðŸ™…','ðŸ’','ðŸ™‹','ðŸ’†','ðŸ’‡','ðŸ’…','ðŸ‘°','ðŸ™Ž','ðŸ™','ðŸ™‡','ðŸŽ©','ðŸ‘‘','ðŸ‘’','ðŸ‘Ÿ','ðŸ‘ž','ðŸ‘¡','ðŸ‘ ','ðŸ‘¢','ðŸ‘•','ðŸ‘”','ðŸ‘š','ðŸ‘—','ðŸŽ½','ðŸ‘–','ðŸ‘˜','ðŸ‘™','ðŸ’¼','ðŸ‘œ','ðŸ‘','ðŸ‘›','ðŸ‘“','ðŸŽ€','ðŸŒ‚','ðŸ’„','ðŸ’›','ðŸ’™','ðŸ’œ','ðŸ’š','â¤','ðŸ’”','ðŸ’—','ðŸ’“','ðŸ’•','ðŸ’–','ðŸ’ž','ðŸ’˜','ðŸ’Œ','ðŸ’‹','ðŸ’','ðŸ’Ž','ðŸ‘¤','ðŸ‘¥','ðŸ’¬','ðŸ‘£','ðŸ’­','ðŸ¶','ðŸº','ðŸ±','ðŸ­','ðŸ¹','ðŸ°','ðŸ¸','ðŸ¯','ðŸ¨','ðŸ»','ðŸ·','ðŸ½','ðŸ®','ðŸ—','ðŸµ','ðŸ’','ðŸ´','ðŸ‘','ðŸ˜','ðŸ¼','ðŸ§','ðŸ¦','ðŸ¤','ðŸ¥','ðŸ£','ðŸ”','ðŸ','ðŸ¢','ðŸ›','ðŸ','ðŸœ','ðŸž','ðŸŒ','ðŸ™','ðŸš','ðŸ ','ðŸŸ','ðŸ¬','ðŸ³','ðŸ‹','ðŸ„','ðŸ','ðŸ€','ðŸƒ','ðŸ…','ðŸ‡','ðŸ‰','ðŸŽ','ðŸ','ðŸ“','ðŸ•','ðŸ–','ðŸ','ðŸ‚','ðŸ²','ðŸ¡','ðŸŠ','ðŸ«','ðŸª','ðŸ†','ðŸˆ','ðŸ©','ðŸ¾','ðŸ’','ðŸŒ¸','ðŸŒ·','ðŸ€','ðŸŒ¹','ðŸŒ»','ðŸŒº','ðŸ','ðŸƒ','ðŸ‚','ðŸŒ¿','ðŸŒ¾','ðŸ„','ðŸŒµ','ðŸŒ´','ðŸŒ²','ðŸŒ³','ðŸŒ°','ðŸŒ±','ðŸŒ¼','ðŸŒ','ðŸŒž','ðŸŒ','ðŸŒš','ðŸŒ‘','ðŸŒ’','ðŸŒ“','ðŸŒ”','ðŸŒ•','ðŸŒ–','ðŸŒ—','ðŸŒ˜','ðŸŒœ','ðŸŒ›','ðŸŒ™','ðŸŒ','ðŸŒŽ','ðŸŒ','ðŸŒ‹','ðŸŒŒ','ðŸŒ ','â­','â˜€','â›…','â˜','âš¡','â˜”','â„','â›„','ðŸŒ€','ðŸŒ','ðŸŒˆ','ðŸŒŠ','ðŸŽ','ðŸ’','ðŸŽŽ','ðŸŽ’','ðŸŽ“','ðŸŽ','ðŸŽ†','ðŸŽ‡','ðŸŽ','ðŸŽ‘','ðŸŽƒ','ðŸ‘»','ðŸŽ…','ðŸŽ„','ðŸŽ','ðŸŽ‹','ðŸŽ‰','ðŸŽŠ','ðŸŽˆ','ðŸŽŒ','ðŸ”®','ðŸŽ¥','ðŸ“·','ðŸ“¹','ðŸ“¼','ðŸ’¿','ðŸ“€','ðŸ’½','ðŸ’¾','ðŸ’»','ðŸ“±','â˜Ž','ðŸ“ž','ðŸ“Ÿ','ðŸ“ ','ðŸ“¡','ðŸ“º','ðŸ“»','ðŸ”Š','ðŸ”‰','ðŸ”ˆ','ðŸ”‡','ðŸ””','ðŸ”•','ðŸ“¢','ðŸ“£','â³','âŒ›','â°','âŒš','ðŸ”“','ðŸ”’','ðŸ”','ðŸ”','ðŸ”‘','ðŸ”Ž','ðŸ’¡','ðŸ”¦','ðŸ”†','ðŸ”…','ðŸ”Œ','ðŸ”‹','ðŸ”','ðŸ›','ðŸ›€','ðŸš¿','ðŸš½','ðŸ”§','ðŸ”©','ðŸ”¨','ðŸšª','ðŸš¬','ðŸ’£','ðŸ”«','ðŸ”ª','ðŸ’Š','ðŸ’‰','ðŸ’°','ðŸ’´','ðŸ’µ','ðŸ’·','ðŸ’¶','ðŸ’³','ðŸ’¸','ðŸ“²','ðŸ“§','ðŸ“¥','ðŸ“¤','âœ‰','ðŸ“©','ðŸ“¨','ðŸ“¯','ðŸ“«','ðŸ“ª','ðŸ“¬','ðŸ“­','ðŸ“®','ðŸ“¦','ðŸ“','ðŸ“„','ðŸ“ƒ','ðŸ“‘','ðŸ“Š','ðŸ“ˆ','ðŸ“‰','ðŸ“œ','ðŸ“‹','ðŸ“…','ðŸ“†','ðŸ“‡','ðŸ“','ðŸ“‚','âœ‚','ðŸ“Œ','ðŸ“Ž','âœ’','âœ','ðŸ“','ðŸ“','ðŸ“•','ðŸ“—','ðŸ“˜','ðŸ“™','ðŸ““','ðŸ“”','ðŸ“’','ðŸ“š','ðŸ“–','ðŸ”–','ðŸ“›','ðŸ”¬','ðŸ”­','ðŸ“°','ðŸŽ¨','ðŸŽ¬','ðŸŽ¤','ðŸŽ§','ðŸŽ¼','ðŸŽµ','ðŸŽ¶','ðŸŽ¹','ðŸŽ»','ðŸŽº','ðŸŽ·','ðŸŽ¸','ðŸ‘¾','ðŸŽ®','ðŸƒ','ðŸŽ´','ðŸ€„','ðŸŽ²','ðŸŽ¯','ðŸˆ','ðŸ€','âš½','âš¾','ðŸŽ¾','ðŸŽ±','ðŸ‰','ðŸŽ³','â›³','ðŸšµ','ðŸš´','ðŸ','ðŸ‡','ðŸ†','ðŸŽ¿','ðŸ‚','ðŸŠ','ðŸ„','ðŸŽ£','â˜•','ðŸµ','ðŸ¶','ðŸ¼','ðŸº','ðŸ»','ðŸ¸','ðŸ¹','ðŸ·','ðŸ´','ðŸ•','ðŸ”','ðŸŸ','ðŸ—','ðŸ–','ðŸ','ðŸ›','ðŸ¤','ðŸ±','ðŸ£','ðŸ¥','ðŸ™','ðŸ˜','ðŸš','ðŸœ','ðŸ²','ðŸ¢','ðŸ¡','ðŸ³','ðŸž','ðŸ©','ðŸ®','ðŸ¦','ðŸ¨','ðŸ§','ðŸŽ‚','ðŸ°','ðŸª','ðŸ«','ðŸ¬','ðŸ­','ðŸ¯','ðŸŽ','ðŸ','ðŸŠ','ðŸ‹','ðŸ’','ðŸ‡','ðŸ‰','ðŸ“','ðŸ‘','ðŸˆ','ðŸŒ','ðŸ','ðŸ','ðŸ ','ðŸ†','ðŸ…','ðŸŒ½','ðŸ ','ðŸ¡','ðŸ«','ðŸ¢','ðŸ£','ðŸ¥','ðŸ¦','ðŸª','ðŸ©','ðŸ¨','ðŸ’’','â›ª','ðŸ¬','ðŸ¤','ðŸŒ‡','ðŸŒ†','ðŸ¯','ðŸ°','â›º','ðŸ­','ðŸ—¼','ðŸ—¾','ðŸ—»','ðŸŒ„','ðŸŒ…','ðŸŒƒ','ðŸ—½','ðŸŒ‰','ðŸŽ ','ðŸŽ¡','â›²','ðŸŽ¢','ðŸš¢','â›µ','ðŸš¤','ðŸš£','âš“','ðŸš€','âœˆ','ðŸ’º','ðŸš','ðŸš‚','ðŸšŠ','ðŸš‰','ðŸšž','ðŸš†','ðŸš„','ðŸš…','ðŸšˆ','ðŸš‡','ðŸš','ðŸš‹','ðŸšƒ','ðŸšŽ','ðŸšŒ','ðŸš','ðŸš™','ðŸš˜','ðŸš—','ðŸš•','ðŸš–','ðŸš›','ðŸšš','ðŸš¨','ðŸš“','ðŸš”','ðŸš’','ðŸš‘','ðŸš','ðŸš²','ðŸš¡','ðŸšŸ','ðŸš ','ðŸšœ','ðŸ’ˆ','ðŸš','ðŸŽ«','ðŸš¦','ðŸš¥','âš ','ðŸš§','ðŸ”°','â›½','ðŸ®','ðŸŽ°','â™¨','ðŸ—¿','ðŸŽª','ðŸŽ­','ðŸ“','ðŸš©','ðŸ” ','ðŸ”¡','ðŸ”¤','ðŸ”¼','ðŸ”½','ðŸ†—','ðŸ”€','ðŸ”','ðŸ”‚','ðŸ†•','ðŸ†™','ðŸ†’','ðŸ†“','ðŸ†–','ðŸ“¶','ðŸŽ¦','ðŸˆ','ðŸš»','ðŸš¹','ðŸšº','ðŸš¼','ðŸš¾','ðŸš°','ðŸˆ¸','ðŸ›‚','ðŸ›„','ðŸ›…','ðŸ›ƒ','ðŸ‰‘','ðŸš¸','â›”','âœ³','â‡','âŽ','âœ…','âœ´','ðŸ’Ÿ','ðŸ†š','ðŸ“³','ðŸ“´','ðŸ…°','ðŸ…±','ðŸ†Ž','ðŸ…¾','ðŸ’ ','âž¿','â™»','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™Ž','â™','â™','â™‘','â™’','â™“','â›Ž','ðŸ”¯','ðŸ§','ðŸ’¹','ðŸ•','ðŸ•œ','ðŸ•‘','ðŸ•','ðŸ•’','ðŸ•ž','ðŸ•“','ðŸ•Ÿ','ðŸ•”','ðŸ• ','ðŸ••','ðŸ•–','ðŸ•—','ðŸ•˜','ðŸ•™','ðŸ•š','ðŸ•¡','ðŸ•¢','ðŸ•£','ðŸ•¤','ðŸ•¥','ðŸ•¦','â™ ','â™¥','â™£','â™¦','ðŸ’®','ðŸ’¯','âœ”','â˜‘','ðŸ”˜','ðŸ”—','âž°','ðŸ”±','ðŸ”²','ðŸ”³','â—¾','â—½','ðŸ”º','â¬œ','â¬›','âš«','âšª','ðŸ”´','ðŸ”µ','ðŸ”»','ðŸ”¶','ðŸ”·','ðŸ”¸','ðŸ”¹'
];

const getRandomEmoji = function(){
  return emojis[Math.floor(Math.random() * emojis.length)];
};
const capitalizeFirstChar = str => {
  const temp = str.replace(/-/g, ' ').replace(/[^\sA-Za-z]/gi, '').trim();
  return temp.charAt(0).toUpperCase() + temp.slice(1);
}
const getNameH1 = name => `# ${getRandomEmoji()} ${capitalizeFirstChar(name)} ${name ? ' | ' : ''}Raining T`;
const getNameH2 = name => `## ${capitalizeFirstChar(name)}`;
const rootBreadCrumb = `> A place to paste re-usable stuff!`;
const readMe = 'README.md';

const generateTable = (items, path, title) => {
  title = title.trim() || 'Content'
  let result = `<table><thead><tr><th></th><th>${title}</th></tr></thead><tbody>`;
  let i = 0;
  for (let el in items) {
    i++;
    result += `<tr><td>${i}</td><td><a href="${(path + '/' + el).substring(2)}">${capitalizeFirstChar(el)}</a></td></tr>`;
  }
  result += '</tbody></table>';
  return result;
}
const generateBreadcrumb = (paths = []) => paths.length === 2 ? rootBreadCrumb : `> ${paths
  .filter(n => n)
  .reduce(
    (previousValue, currentValue) => [...previousValue, `${previousValue.pop() || '.'}/${currentValue}`],
    []
  )
  .map(folder => {
    const tempFolder = folder.substring(4);
    const lastSlashIndex = tempFolder.lastIndexOf('/') + 1;
    return `[${!tempFolder ? 'ðŸ ' : capitalizeFirstChar(tempFolder.substring(lastSlashIndex))}](/${tempFolder})`;
  })
  .join(" > ")
}`;


glob("./**/*.md", async (err, files) => {
  if (err) {
    console.error(err);
    return false;
  }

  let rows = {};
  await Promise.all(
    files.map(async (filePath) => {
      if(filePath.includes('node_modules')) return false;
      const correctFilePath = filePath.substring(2, filePath.length - 10);
      correctFilePath.split("/").reduce((dir, path) => {
        if(!dir[path]) dir[path] = {};
        return dir[path];
      }, rows);
    })
  );

  delete rows[''];
  const traverseFolders = async (path, level = rows) => {
    let content = '';
    const name = path.split('/').pop();
    const title = getNameH1(name) + "\n\n";
    const titleH2 = getNameH2(name) + "\n\n";
    const breadcrumb = generateBreadcrumb(path.split('/'));
    const childrenTable = [];

    // walk sub-folders
    for (const [key, value] of Object.entries(level)) {
      const isLeaf = Object.values(value).length === 0;
      if(isLeaf) {
        // console.log(key)
        // try {
        //   const content = await fs.readFile(`${path}/${readMe}`, "binary");
        //   table = content.match(/^#(?!include).*$/gm);
        // } catch (e) {
        //   console.log("Some error happened!", e);
        // }
      } else {
        const childTable = await traverseFolders(`${path}/${key}`, value);
        childrenTable.push(childTable);
      }
    }

    content += `\n\n${generateTable(level, path, capitalizeFirstChar(name))}`;
    content += `\n\n${childrenTable.join("\n\n")}`;
    await fs.writeFile(`${path}/${readMe}`, `${title}${breadcrumb}${content}`);

    return titleH2 + breadcrumb + content;
  }

  await traverseFolders('./', rows);
});
